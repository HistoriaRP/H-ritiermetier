<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>H√©ritier-RP ¬∑ Bureau des M√©tiers</title>
<meta name="color-scheme" content="dark light"/>

<!-- ====== Styles ====== -->
<style>
:root{
  --bg:#0b0f14; --bg-2:#07090c; --card:#0f141b; --muted:#9aa4af; --text:#e6e9ef;
  --accent:#fbbf24; --accent-2:#10b981; --danger:#ef4444; --border:#1f2937;
  --shadow:0 0 0 1px rgba(255,255,255,.04); --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";
  background:#000;
  overflow-x:hidden;
}

/* Background parallax */
.bg-wrap{
  position:fixed; inset:0; z-index:-2; overflow:hidden;
  filter:saturate(.9) contrast(1);
}
.bg{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(1.05);
  min-width:110%; min-height:110%;
  background:url("assets/bg.jpg") center/cover no-repeat;
  opacity:.35;
  will-change:transform;
}
.vignette::after{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
  background:radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,.45) 75%, rgba(0,0,0,.75) 100%);
}

/* Glow blobs */
.blob{position:fixed; width:38vw; height:38vw; border-radius:50%; filter:blur(60px); opacity:.16; z-index:-1}
.blob.a{left:-12vw; top:-12vw; background:#fbbf24}
.blob.b{right:-14vw; bottom:-16vw; background:#10b981}

/* Layout */
.container{max-width:1100px; margin:0 auto; padding:24px}
.row{display:flex; gap:12px; flex-wrap:wrap}

.card{
  background:linear-gradient(135deg, rgba(17,22,30,.92), rgba(17,22,30,.7));
  border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); overflow:hidden; position:relative;
  transform:translateZ(0);
}
.card .p{padding:18px}
.title{font-weight:900; letter-spacing:-.02em}
.badge{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em}
.muted{color:var(--muted)}
.divider{height:1px; background:linear-gradient(90deg,transparent,rgba(251,191,36,.45),transparent)}
.grid{display:grid; gap:14px}
@media(min-width:860px){ .cols-2{grid-template-columns:1fr 1fr} }

/* Buttons */
.btn{
  appearance:none; border:1px solid var(--border); background:#0f141b; color:var(--text);
  padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s; position:relative; overflow:hidden;
}
.btn:hover{border-color:#364152; transform:translateY(-1px)}
.btn.primary{background:var(--accent); color:#111; border-color:transparent}
.btn.green{background:var(--accent-2); color:#111; border-color:transparent}
.btn.danger{background:#7f1d1d; border-color:#991b1b; color:#fff}
.btn[disabled]{opacity:.55; cursor:not-allowed}

.btn .shine{
  position:absolute; inset:-100% -40%; transform:skewX(-18deg);
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
  animation:shine 3.2s infinite;
}
@keyframes shine{ 0%{left:-120%} 60%{left:120%} 100%{left:120%} }

/* Inputs */
input, textarea{
  width:100%; background:#0b1017; border:1px solid var(--border); color:var(--text);
  padding:10px 12px; border-radius:12px; outline:none; transition:.2s;
}
input:focus, textarea:focus{border-color:var(--accent)}

/* Meter */
.bar{height:8px; background:#0e1420; border-radius:999px; overflow:hidden}
.fill{height:8px; background:var(--accent); transform-origin:left; transition:width .35s}

/* Modal */
.backdrop{position:fixed; inset:0; background:rgba(0,0,0,.6); display:grid; place-items:center; padding:24px; z-index:50}
.modal{
  width:100%; max-width:680px; background:#0e131a; border:1px solid var(--border);
  border-radius:20px; box-shadow:0 30px 120px rgba(0,0,0,.55); overflow:hidden
}
.modal .head{padding:16px 18px 0}
.modal .content{padding:18px}
.actions{display:flex; justify-content:flex-end; gap:8px; padding:0 18px 18px}

/* Toasts */
.toastHost{position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:70}
.toast{
  background:#0f141b; border:1px solid var(--border); color:var(--text);
  padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); animation:pop .25s ease-out both
}
@keyframes pop{from{transform:translateY(6px); opacity:0} to{transform:translateY(0); opacity:1}}

/* Top bar debug */
#debug{
  position:fixed; right:12px; bottom:12px; width:300px; max-height:40vh; overflow:auto;
  font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:#cbd5e1;
  background:#0b0f14cc; border:1px solid #1f2937; padding:8px 10px; border-radius:10px; z-index:80;
}
#debug b{color:#fbbf24}
</style>

<!-- GSAP (micro-animations) -->
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="vignette">
<div class="bg-wrap"><div class="bg" id="bg"></div></div>
<div class="blob a"></div><div class="blob b"></div>

<header style="padding:28px 0 8px">
  <div class="container">
    <h1 class="title" style="font-size:34px">H√©ritier-RP <span style="color:var(--accent)">/</span> Bureau des M√©tiers</h1>
    <p class="muted" style="max-width:760px; margin-top:8px">
      Choisir un m√©tier ici <strong style="color:var(--accent)">ne vaut pas attribution IG</strong>. C‚Äôest une
      <em>demande</em> pour r√©server un slot et organiser la Cit√©. Validation finale aupr√®s du <strong>maire</strong> en jeu, ou via
      <strong>cr√©ation d‚Äôentreprise</strong> (ticket Discord).
    </p>
    <div class="row" style="margin-top:16px">
      <button id="btnAdmin" class="btn"><span class="shine"></span>Mode admin</button>
      <button id="btnAddJob" class="btn primary" style="display:none"><span class="shine"></span>+ Ajouter un m√©tier</button>
      <button id="btnExport" class="btn"><span class="shine"></span>Exporter CSV</button>
      <button id="btnTicket" class="btn"><span class="shine"></span>Demander un ticket (Discord)</button>
    </div>
    <div style="margin-top:16px"><input id="search" placeholder="Rechercher un m√©tier‚Ä¶"/></div>
    <div class="badge" id="rtdbState" style="margin-top:8px">RTDB : ‚Ä¶</div>
  </div>
</header>

<main class="container" id="content"></main>

<section class="container" style="margin-top:28px">
  <div class="divider"></div>
  <h2 class="badge" style="margin:12px 0">Cr√©er une entreprise (Ticket Discord)</h2>
  <div class="card"><div class="p">
    <p class="muted">Vous pouvez proposer une <strong>entreprise RP</strong>. Ouvrez un <strong>ticket</strong> sur le Discord.
      Utilisez le gabarit ci-dessous et soyez pr√©cis :</p>
    <label class="badge" style="display:block; margin-top:14px">Gabarit (copier/coller)</label>
    <textarea id="ticket" rows="10" readonly></textarea>
    <div style="margin-top:8px" class="row">
      <button id="copyTicket" class="btn primary"><span class="shine"></span>Copier le gabarit</button>
      <button id="openTicket" class="btn"><span class="shine"></span>Ouvrir #Ticket</button>
    </div>
  </div></div>
</section>

<div id="modalHost"></div>
<div class="toastHost" id="toasts"></div>
<pre id="debug"></pre>

<script>
/* ----------------------- CONFIG ----------------------- */
const DISCORD = {
  guildId: "1047583737015181433",
  ticketChannelId: "1300245121073287319",
  WEBHOOK_URL_ALERTS: "https://discord.com/api/webhooks/1432636530119147531/yapHynHSrUnSeZMkJA5ka5-37bBGH--uxDu8AdFRFqJofmOUtqqdk0umohyA4I5GhAS7"
};
const ADMIN_PASSWORD = "HERITIERS-\u03A9-Imperium#2099";

const firebaseConfig = {
  apiKey: "AIzaSyD5hOepRTvpsSNCmpwnhzQSYyhJO6C1P-c",
  authDomain: "heritier-85264.firebaseapp.com",
  databaseURL: "https://heritier-85264-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "heritier-85264",
  storageBucket: "heritier-85264.firebasestorage.app",
  messagingSenderId: "859188258053",
  appId: "1:859188258053:web:2f55f3a0926c0ff254436c",
  measurementId: "G-JN93SKZ3P1"
};

/* ----------------------- INIT ----------------------- */
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

const content   = document.getElementById("content");
const modalHost = document.getElementById("modalHost");
const btnAdmin  = document.getElementById("btnAdmin");
const btnAddJob = document.getElementById("btnAddJob");
const btnExport = document.getElementById("btnExport");
const btnTicket = document.getElementById("btnTicket");
const searchInput = document.getElementById("search");
const rtdbState = document.getElementById("rtdbState");
const toasts = document.getElementById("toasts");
const debug = document.getElementById("debug");

let isAdmin = false, isAdminRT = false, isAdminPwd = false;
let currentUID = null;
let jobs = [];
const applicantsMap = {}; // jobId -> {pushId:{handle,at}}

logInfo("Boot‚Ä¶");

/* Background parallax */
(() => {
  const bg = document.getElementById("bg");
  window.addEventListener("mousemove",(e)=>{
    const x = (e.clientX / innerWidth - 0.5) * 6;
    const y = (e.clientY / innerHeight - 0.5) * 6;
    bg.style.transform = `translate(-50%,-50%) scale(1.05) translate(${x}px,${y}px)`;
  });
})();

/* Ticket gabarit */
const TICKET = `[Cr√©ation d‚Äôentreprise] ‚Äî Nom :

1) Concept & objectifs :
- 

2) Emplacement :
- 

3) √âquipe & r√¥les :
- Fondateur(s) :
- Effectif initial :
- Slots demand√©s :

4) Technique & logistique :
- Ressources / appro :
- V√©hicules / stockage :

5) R√®glement & s√©curit√© :
- Risques identifi√©s :
- Proc√©dures pr√©vues :

6) Ambition & calendrier :
- √âtapes / dates :
- √âv√©nements d‚Äôouverture :

7) Comp√©tences / formation :
- 

8) √âconomie RP :
- Tarifs / troc :
- Salaires :
- Partenariats :

Contacts Discord : <votre_pseudo>`;
document.getElementById("ticket").value = TICKET;
document.getElementById("copyTicket").onclick = ()=>{ navigator.clipboard.writeText(TICKET); toast("Gabarit copi√© ‚úÖ"); };
document.getElementById("openTicket").onclick = ()=> window.open(`https://discord.com/channels/${DISCORD.guildId}/${DISCORD.ticketChannelId}`,"_blank");

/* Auth (anonyme) */
auth.signInAnonymously().catch(err=>logErr("auth.signInAnonymously",err));
auth.onAuthStateChanged(async (user)=>{
  currentUID = user?.uid || null;
  logInfo("onAuthStateChanged ‚Üí UID="+(currentUID||"(null)"));
  await refreshAdminFlags();
  rtdbState.textContent = `RTDB: connect√©: ${!!user} ‚Äî UID=${currentUID||"(null)"} ‚Äî AdminRT: ${isAdminRT}`;
  bootRealtime();
});

/* Admin flag (RTDB + password sticky for session) */
async function refreshAdminFlags(){
  isAdminPwd = isAdminPwd; // keep session flag
  if(currentUID){
    try{
      const snap = await db.ref("admins/"+currentUID).get();
      isAdminRT = !!snap.val();
    }catch(e){ isAdminRT = false; logErr("adminCheck",e); }
  }else isAdminRT = false;
  isAdmin = isAdminRT || isAdminPwd;
  btnAddJob.style.display = isAdmin ? "" : "none";
}

/* Listeners */
function bootRealtime(){
  db.ref("jobs").on("value", snap=>{
    const val = snap.val();
    jobs = val ? Object.values(val).sort((a,b)=> a.cat.localeCompare(b.cat) || a.title.localeCompare(b.title)) : [];
    // listen applicants
    jobs.forEach(j=>{
      if(!applicantsMap[j.id]) applicantsMap[j.id] = {};
      db.ref("applicants/"+j.id).off();
      db.ref("applicants/"+j.id).on("value", s=>{
        applicantsMap[j.id] = s.val() || {};
        render();
      });
    });
    render();
    if(!val) infoEmpty();
  }, err=> logErr("jobs.on(value)", err));

  // Connection state
  firebase.database().ref(".info/connected").on("value", s=>{
    logInfo("info.connected="+s.val());
    document.getElementById("rtdbState").dataset.connected = s.val();
  });
}

/* ------------- UI helpers ------------- */
const h=(tag,attrs={},...children)=>{const el=document.createElement(tag);
  for(const k in attrs){
    if(k.startsWith("on") && typeof attrs[k]==="function") el.addEventListener(k.slice(2).toLowerCase(), attrs[k]);
    else if(attrs[k]===true) el.setAttribute(k,"");
    else if(attrs[k]!==false && attrs[k]!=null) el.setAttribute(k, attrs[k]);
  }
  for(const c of children.flat()){ if(c==null) continue; el.appendChild(typeof c==="string"?document.createTextNode(c):c); }
  return el; };
const byCat=(list)=>{const m=new Map(); list.forEach(j=>{ if(!m.has(j.cat)) m.set(j.cat,[]); m.get(j.cat).push(j); }); return [...m.entries()].map(([name,items])=>({name,items}))};
function sectionTitle(text){const w=h("div"); w.appendChild(h("div",{class:"divider"})); w.appendChild(h("h2",{class:"badge",style:"margin:12px 0"},text)); w.appendChild(h("div",{class:"divider"})); return w;}
function toast(msg){const t=h("div",{class:"toast"}, msg); toasts.appendChild(t); setTimeout(()=> t.remove(), 4200);}
function glow(el){gsap.fromTo(el,{boxShadow:"0 0 0 0 rgba(251,191,36,.0)"},{boxShadow:"0 0 50px 5px rgba(251,191,36,.25)", duration:.35, yoyo:true, repeat:1});}

/* ------------- Render ------------- */
searchInput.addEventListener("input",render);

function render(){
  const q=(searchInput.value||"").trim().toLowerCase();
  const defs=!q?jobs:jobs.filter(j=> j.title.toLowerCase().includes(q) || (j.description||"").toLowerCase().includes(q));
  const cats=byCat(defs);
  content.innerHTML="";
  cats.forEach(cat=>{
    content.appendChild(sectionTitle(cat.name));
    const grid=h("div",{class:"grid cols-2"});
    cat.items.forEach(job=> grid.appendChild(jobCard(job)));
    content.appendChild(grid);
  });
}

function jobCard(job){
  const appl=applicantsMap[job.id]||{}; const taken=Object.keys(appl).length;
  const full=taken>=(job.slotsMax||1); const pct=Math.min(100, Math.round((taken/(job.slotsMax||1))*100));

  const card=h("article",{class:"card"}); const body=h("div",{class:"p"});
  const head=h("div",{class:"row",style:"justify-content:space-between; align-items:flex-start"});
  head.appendChild(h("div",{}, h("div",{class:"title",style:"font-size:20px"},job.title), h("div",{class:"muted",style:"margin-top:6px"},job.description||"")));
  head.appendChild(h("div",{style:"text-align:right"}, h("div",{class:"badge"},"Slots"), h("div",{style:"font-weight:800; font-size:18px"}, `${taken}/`, h("span",{class:"muted"}, String(job.slotsMax)))));
  body.appendChild(head);
  body.appendChild(h("div",{class:"bar",style:"margin-top:10px"}, h("div",{class:"fill",style:`width:${pct}%`})));

  const row=h("div",{class:"row",style:"margin-top:12px; justify-content:space-between"});
  row.appendChild(h("button",{class:`btn ${full?'':'green'}`,disabled:full,onclick:()=>openApply(job)}, full?"Complet":"Postuler"));
  if(isAdmin){
    const adminRow=h("div",{class:"row"});
    adminRow.appendChild(h("button",{class:"btn",onclick:()=>openJobModal("edit",job)},"√âditer"));
    adminRow.appendChild(h("button",{class:"btn danger",onclick:()=>openDelete(job)},"Suppr"));
    row.appendChild(adminRow);
  }
  body.appendChild(row);

  if(isAdmin && taken>0){
    const list=h("div",{style:"margin-top:12px; border-top:1px solid var(--border); padding-top:12px"});
    list.appendChild(h("div",{class:"badge",style:"margin-bottom:6px"},"Candidats"));
    Object.entries(appl).forEach(([key,a])=>{
      list.appendChild(h("div",{class:"row",style:"justify-content:space-between"},
        h("div",{}, a.handle),
        h("div",{class:"badge"},
          new Date(a.at).toLocaleString()," ",
          h("button",{class:"btn danger",style:"margin-left:8px; padding:4px 8px",onclick:()=>kickApplicant(job.id,key)},"Retirer")
        )
      ));
    });
    body.appendChild(list);
  }

  card.appendChild(body);
  gsap.from(card,{y:8,opacity:0,duration:.3, ease:"power2.out"});
  return card;
}

/* ------------- CRUD ------------- */
async function addJob(def){
  const id = def.id || ("job_"+Date.now());
  await db.ref("jobs/"+id).set({
    id, title:def.title||"Sans titre", cat:def.cat||"Divers",
    description:def.description||"", slotsMax:Math.max(1, parseInt(def.slotsMax,10)||1)
  });
  alertDiscord(`‚ûï M√©tier cr√©√© : **${def.title}** (${def.cat})`);
}
async function editJob(id, patch){
  const j = jobs.find(x=>x.id===id); if(!j) return;
  const newSlots = patch.slotsMax!=null ? Math.max(1, parseInt(patch.slotsMax,10)||j.slotsMax) : j.slotsMax;
  await db.ref("jobs/"+id).update({
    title: patch.title??j.title, cat: patch.cat??j.cat,
    description: patch.description??j.description, slotsMax: newSlots
  });
  alertDiscord(`‚úèÔ∏è M√©tier modifi√© : **${patch.title||j.title}**`);
}
async function deleteJob(id){
  const j = jobs.find(x=>x.id===id); if(!j) return;
  await db.ref("jobs/"+id).remove();
  await db.ref("applicants/"+id).remove();
  alertDiscord(`üóëÔ∏è M√©tier supprim√© : **${j.title}**`);
}
async function applyToJob(jobId, handle){
  const job = jobs.find(j=>j.id===jobId); if(!job) return alert("M√©tier introuvable.");
  const list = Object.values(applicantsMap[jobId]||{});
  if(list.some(a => (a.handle||"").toLowerCase()===handle.toLowerCase())) return alert("Tu as d√©j√† postul√©.");
  if(list.length >= (job.slotsMax||1)) return alert("D√©sol√©, ce m√©tier est complet.");
  await db.ref("applicants/"+jobId).push({handle, at:new Date().toISOString()});
  glow(document.body); toast("Candidature envoy√©e ‚úÖ");
  alertDiscord(`üì® Candidature **${handle}** ‚Üí **${job.title}**`);
}
async function kickApplicant(jobId, pushId){ await db.ref("applicants/"+jobId+"/"+pushId).remove(); }

/* ------------- Modales ------------- */
btnAdmin.onclick = ()=> openAdminLogin();
btnAddJob.onclick = ()=> openJobModal("add");
btnExport.onclick = ()=> exportCSV();
btnTicket.onclick = ()=> window.open(`https://discord.com/channels/${DISCORD.guildId}/${DISCORD.ticketChannelId}`,"_blank");

function openAdminLogin(){
  const close=()=> modalHost.innerHTML="";
  modalHost.innerHTML="";
  modalHost.appendChild(
    h("div",{class:"backdrop"},
      h("div",{class:"modal"},
        h("div",{class:"head"}, h("h3",{class:"title",style:"font-size:20px"},"Mode admin")),
        h("div",{class:"content"},
          h("p",{class:"muted"},"Deux options :"),
          h("ol",{},
            h("li",{}, "Ajoute cet UID dans RTDB ‚Üí ", h("code",{},"admins/"+(currentUID||"(non connect√©)")), " : ", h("b",{},"true")),
            h("li",{}, "Ou bien entre le mot de passe admin ci-dessous.")
          ),
          h("div",{style:"height:8px"}),
          h("label",{class:"badge"},"Mot de passe admin"),
          h("input",{type:"password",id:"pw",placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"}),
          h("div",{class:"badge",style:"margin-top:10px"},"UID : ", currentUID||"(non connect√©)")
        ),
        h("div",{class:"actions"},
          h("button",{class:"btn",onclick:close},"Fermer"),
          h("button",{class:"btn green",onclick:async()=>{
            const ok = document.getElementById("pw").value===ADMIN_PASSWORD;
            if(!ok){ toast("Mot de passe incorrect ‚ùå"); return; }
            isAdminPwd = true; await refreshAdminFlags(); toast("Admin d√©verrouill√© ‚úÖ"); alertDiscord("üîê Admin d√©verrouill√© via mot de passe.");
            close(); render();
          }},"D√©verrouiller")
        )
      )
    )
  );
  setTimeout(()=> document.getElementById("pw")?.focus(), 0);
}

function openApply(job){
  let discord=""; const close=()=> modalHost.innerHTML="";
  modalHost.innerHTML="";
  modalHost.appendChild(
    h("div",{class:"backdrop"},
      h("div",{class:"modal"},
        h("div",{class:"head"}, h("h3",{class:"title",style:"font-size:20px"},"Postuler ‚Äî ",job.title)),
        h("div",{class:"content"},
          h("label",{class:"badge"},"Pseudo Discord"),
          h("input",{id:"applyInput",placeholder:"Ex: Enzo#1234",oninput:e=>{discord=e.target.value}})
        ),
        h("div",{class:"actions"},
          h("button",{class:"btn",onclick:close},"Annuler"),
          h("button",{class:"btn green",onclick:async()=>{ if(!discord.trim()) return alert("Indique ton pseudo Discord"); await applyToJob(job.id, discord.trim()); close(); }},"Envoyer")
        )
      )
    )
  );
  setTimeout(()=> document.getElementById("applyInput")?.focus(), 0);
}
function openJobModal(mode, job){
  let form = job ? {title:job.title, cat:job.cat, description:job.description||"", slotsMax:job.slotsMax}
                 : {title:"", cat:"Civils & Service", description:"", slotsMax:1};
  const close=()=> modalHost.innerHTML="";
  modalHost.innerHTML="";
  modalHost.appendChild(
    h("div",{class:"backdrop"},
      h("form",{class:"modal", onsubmit:async e=>{
          e.preventDefault();
          if(!isAdmin){ toast("Admin requis"); return; }
          if(mode==="add") await addJob(form); else await editJob(job.id, form);
          close();
        }},
        h("div",{class:"head"}, h("h3",{class:"title",style:"font-size:20px"}, mode==="add"?"Ajouter un m√©tier":`√âditer ‚Äî ${job.title}`)),
        h("div",{class:"content"},
          h("label",{class:"badge"},"Nom du m√©tier"),
          h("input",{value:form.title,required:true,oninput:e=>{form.title=e.target.value}}),
          h("div",{style:"height:8px"}),
          h("label",{class:"badge"},"Cat√©gorie"),
          h("input",{value:form.cat,required:true,oninput:e=>{form.cat=e.target.value}}),
          h("div",{style:"height:8px"}),
          h("label",{class:"badge"},"Description"),
          h("textarea",{rows:4,oninput:e=>{form.description=e.target.value}},form.description),
          h("div",{style:"height:8px"}),
          h("label",{class:"badge"},"Slots max"),
          h("input",{type:"number",min:"1",value:form.slotsMax,required:true,oninput:e=>{form.slotsMax=e.target.value}})
        ),
        h("div",{class:"actions"},
          h("button",{type:"button",class:"btn",onclick:close},"Annuler"),
          h("button",{class:"btn green",type:"submit"},"Enregistrer")
        )
      )
    )
  );
}
function openDelete(job){
  const close=()=> modalHost.innerHTML="";
  modalHost.innerHTML="";
  modalHost.appendChild(
    h("div",{class:"backdrop"},
      h("div",{class:"modal"},
        h("div",{class:"head"}, h("h3",{class:"title",style:"font-size:20px"},"Confirmation")),
        h("div",{class:"content"}, h("p",{},"Supprimer d√©finitivement le m√©tier ",h("strong",{},job.title)," ?")),
        h("div",{class:"actions"},
          h("button",{class:"btn",onclick:close},"Annuler"),
          h("button",{class:"btn danger",onclick:async()=>{ await deleteJob(job.id); close(); }},"Confirmer")
        )
      )
    )
  );
}

/* ------------- Export CSV ------------- */
function exportCSV(){
  const rows = ["job_id;categorie;job_title;discord;applied_at"];
  jobs.forEach(j=>{
    const list = Object.values(applicantsMap[j.id]||{});
    list.forEach(a=> rows.push(`${j.id};"${j.cat}";"${j.title}";"${a.handle}";${a.at}`));
  });
  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "he_jobs_export.csv"; a.click();
  URL.revokeObjectURL(url);
}

/* ------------- Discord alerts (Webhook) ------------- */
async function alertDiscord(text){
  if(!DISCORD.WEBHOOK_URL_ALERTS) return;
  try{
    await fetch(DISCORD.WEBHOOK_URL_ALERTS,{
      method:"POST", headers:{ "Content-Type":"application/json"},
      body: JSON.stringify({
        content: text,
        allowed_mentions: { parse: [] },
        embeds: [{
          title: "Bureau des M√©tiers ‚Äî LIVE",
          description: text,
          color: 0xFBBF24,
          footer: { text: `UID: ${currentUID||'anon'} ‚Ä¢ ${new Date().toLocaleString()}` }
        }]
      })
    });
    logInfo("Webhook OK: "+text);
  }catch(e){ logErr("Webhook", e); }
}

/* ------------- Empty DB migration hint ------------- */
function infoEmpty(){
  const local = loadLocalLegacy();
  if(local.jobs?.length){
    if(confirm("Aucune donn√©e en base. Importer vos m√©tiers/candidatures locales vers le LIVE ?")){
      migrateFromLocalToRTDB(local);
    }
  }
}
const STORAGE_KEY = "he_jobs_html_v1";
function loadLocalLegacy(){
  try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : {jobs:[]}; }
  catch{ return {jobs:[]}; }
}
async function migrateFromLocalToRTDB(localState){
  try{
    if(!isAdmin){ alert("√âchec migration : tu n'es pas admin."); return; }
    const defs = {}, updates = {};
    (localState.jobs||[]).forEach(j=>{
      defs[j.id] = { id:j.id, title:j.title, cat:j.cat, description:j.description||"", slotsMax:j.slotsMax||1 };
      (j.applicants||[]).forEach(a=>{
        const k = db.ref("applicants/"+j.id).push().key;
        updates["applicants/"+j.id+"/"+k] = {handle:a.handle, at:a.at || new Date().toISOString()};
      });
    });
    await db.ref("jobs").set(defs);
    if(Object.keys(updates).length) await db.ref().update(updates);
    alertDiscord("‚òÅÔ∏è Migration locale ‚Üí LIVE effectu√©e.");
    toast("Migration termin√©e ‚úÖ");
  }catch(e){ logErr("migration", e); alert("√âchec migration : "+e.message); }
}

/* ------------- Logs ------------- */
function logInfo(msg){ debug.insertAdjacentHTML("beforeend", `<div><b>[info]</b> ${escapeHtml(String(msg))}</div>`); debug.scrollTop = debug.scrollHeight; }
function logErr(label, err){ console.error(label, err); debug.insertAdjacentHTML("beforeend", `<div style="color:#fca5a5"><b>[${escapeHtml(label)}]</b> ${escapeHtml(err.message||String(err))}</div>`); debug.scrollTop = debug.scrollHeight; }
function escapeHtml(s){return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}

/* ------------- Splash micro-animations ------------- */
gsap.from(".title",{y:8,opacity:0,duration:.45, ease:"power2.out"});

</script>
</body>
</html>
